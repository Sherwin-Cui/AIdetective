# 雨夜谜案 - 雨夜山庄谋杀案

## 游戏概述
《雨夜谜案》是一款文字冒险推理游戏，玩家扮演一名私家侦探，在一个与世隔绝的山庄中调查主人的神秘死亡事件。游戏结合了场景探索、线索收集、NPC对话等经典侦探游戏元素。

## 技术架构
- 前端技术：HTML5/CSS3/JavaScript
- LLM集成：deepseek v3
- 数据存储：localStorage
- 第三方库：无

## 游戏设计

### 核心机制
1. **场景探索**：玩家可以在不同的场景间切换，每个场景都有独特的调查点
2. **线索收集**：通过调查场景中的物品获得线索，线索分为物证、证词、推理三类
3. **NPC对话**：与场景中的NPC进行对话，获取信息和线索
4. **推理系统**：整合收集到的线索进行推理，最终找出真相

### 游戏流程图
```
开始游戏 → 查看故事背景 → 进入游戏主界面
    ↓
场景切换 ←→ 场景调查(获得线索)
    ↓
NPC对话(获取信息) ←→ 线索查看
    ↓
整合线索进行推理 → 找出真凶 → 游戏结束
```

### AI角色设计
#### 角色设定
- **林晨**：死者林山庄的儿子，35岁，商人
- **老陈**：山庄管家，60岁，忠诚可靠
- **李医生**：受邀医生，45岁，专业冷静
- **小美**：山庄女仆，22岁，年轻单纯
- **陈雅琴**：死者妻子，60岁，优雅端庄

#### 核心提示词
每个角色都有详细的系统提示词，包含：
- 角色基本设定
- 核心秘密
- 情绪触发机制
- 线索触发条件

#### 增强提示词模板
增强的提示词模板包含以下要素：
- 详细背景信息（时间线、人际关系、已知信息）
- 当前情境分析（时间上下文、情绪指导）
- 对话历史管理
- 回复要求规范

#### 情绪分析系统
实现了一个复杂的情绪分析系统，包含：
- 情绪强度计算
- 情绪稳定性评估
- 情绪波动检测
- 情绪趋势分析

### 界面设计

#### 配色方案
| 用途 | 色值 | 说明 |
|:---:|:---:|:---:|


#### 字体规范
| 元素 | 字体 | 大小 | 字重 |
|:---:|:---:|:---:|:---:|


### 交互设计
- 点击式交互，所有操作通过点击完成
- 模态框形式显示详细信息
- 平滑过渡动画提升用户体验

## 开发进度

### 功能模块
| 模块 | 状态 | 说明 |
|:---:|:---:|:---:|
| 游戏引擎 | 已完成 | 核心游戏循环和状态管理 |
| AI系统 | 已完成 | 本地AI对话功能已完全集成 |
| 界面系统 | 已完成 | 响应式设计，适配不同设备 |
| 数据管理 | 已完成 | 使用localStorage进行数据持久化 |

### 功能检查表
- [x] 核心游戏循环
- [x] 场景切换与调查
- [x] 线索收集与管理
- [x] 基础NPC对话
- [x] LLM API集成
- [x] AI角色对话系统
- [x] 情绪化对话响应
- [x] 线索触发机制
- [x] 游戏状态管理
- [x] 界面响应更新
- [x] 错误处理机制
- [x] 数据持久化
- [x] 游戏结束逻辑

## API配置说明

游戏使用Ollama作为本地LLM服务提供者，详细配置说明请参见 [AI服务配置说明](AI_SERVICE_CONFIG.md)。

### 快速开始

1. 安装 [Ollama](https://ollama.com/)
2. 下载推荐模型：`ollama pull qwen2:1.5b`
3. 启动Ollama服务
4. 打开 `index.html` 开始游戏

## 游戏玩法说明
1. 开始游戏后阅读故事背景
2. 在不同场景中调查获取线索
3. 与NPC对话获取更多信息
4. 整合线索推理找出真凶

## 优化建议
1. 增加更多AI角色和对话内容
2. 添加音效和背景音乐
3. 增加多结局设计
4. 优化移动端体验

## 测试工具
项目包含以下测试工具用于验证AI角色和系统功能：

### 测试工具

### 提示词增强测试
- 文件：`test_prompt_enhancement.html`
- 功能：测试增强提示词模板的构建和情绪分析功能
- 包含：基础提示词与增强提示词对比、情绪趋势分析、角色一致性测试、线索一致性测试

### 角色一致性测试报告
- 文件：`test_character_consistency.html`
- 功能：批量测试所有角色的一致性并生成详细报告
- 包含：角色设定一致性检查、线索触发规则验证、可视化测试结果、统计摘要

### 最终集成测试报告
- 文件：`final_integration_test.html`
- 功能：展示所有已完成的功能和测试结果，提供模块状态和核心功能验证
- 包含：模块集成状态汇总、功能测试结果展示、最终验证报告

## AI中间层集成开发计划

### 第一步：集成AI服务模块
- [x] 替换现有的AIService模块
- [x] 实现与Ollama API的交互
- [x] 添加服务状态检查功能
- [x] 提供默认回复机制

### 第二步：集成提示词构建模块
- [x] 替换现有的PromptBuilder模块
- [x] 实现角色专属提示词构建
- [x] 添加对话历史管理
- [x] 实现线索触发上下文

### 第三步：集成响应解析模块
- [x] 替换现有的ResponseParser模块
- [x] 实现AI响应解析
- [x] 添加情绪状态识别
- [x] 实现线索判定解析

### 第四步：集成对话系统
- [x] 替换现有的DialogueSystem模块
- [x] 实现新的对话启动方法
- [x] 实现新的消息发送方法
- [x] 添加气泡和头像高亮功能

### 第五步：完善调试工具
- [x] 集成调试工具模块
- [x] 添加连接测试功能
- [x] 添加角色对话测试
- [x] 添加线索触发测试

### 集成测试报告
- [x] 创建最终集成测试报告页面
- [x] 汇总所有模块状态和功能验证结果
- [x] 提供可视化测试结果展示

## 最终总结
所有计划功能已全部完成并经过充分测试。游戏现已具备完整的侦探推理体验，包括：

- 丰富的场景和线索系统
- 五个具有独特性格和秘密的AI角色
- 增强的提示词系统，确保角色一致性
- 情绪化对话响应机制
- 线索触发的动态对话
- 完整的游戏状态管理和数据持久化

游戏已准备好供最终用户游玩。玩家可以通过与NPC对话、收集线索、分析证据来解开雨夜山庄的谋杀之谜。