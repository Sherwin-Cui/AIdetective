ä¿®æ”¹æ–¹æ¡ˆæ¦‚è§ˆ
1. æ•°æ®ç»“æ„æ”¹åŠ¨

ä¿®æ”¹å¯¹è¯å†å²è®°å½•æ ¼å¼ï¼Œæ”¯æŒæ¯è½®å¯¹è¯é™„å¸¦è¯æ®
æ–°å¢è¯æ®åˆ†æç³»ç»Ÿï¼Œå®æ—¶è·Ÿè¸ªè¯æ˜è¿›åº¦
è°ƒæ•´ç»“å±€åˆ¤å®šé€»è¾‘ï¼Œæ”¯æŒåŠ¨æ€åˆ¤æ–­

2. UIäº¤äº’æ”¹åŠ¨

ç§»é™¤åŸæœ‰çš„è¯æ®é€‰æ‹©æ¨¡æ€æ¡†
åœ¨å¯¹è¯è¾“å…¥æ¡†æ—æ·»åŠ "é™„åŠ è¯æ®"æŒ‰é’®
å®æ—¶æ˜¾ç¤ºå½“å‰éœ€è¦è¯æ˜çš„è¦ç´ 
ç¬¬ä¸€æ¬¡å¯¹è¯è‡ªåŠ¨å‘é€"XXXï¼Œä½ å°±æ˜¯å‡¶æ‰‹ï¼"

3. ç³»ç»Ÿé€»è¾‘æ”¹åŠ¨

å®ç°æ–°çš„è¯æ®è¯„åˆ†ç³»ç»Ÿ
åŠ¨æ€åˆ¤æ–­é€šå…³æ¡ä»¶
åŸºäºAIå“åº”æ›´æ–°UIæç¤º

è¯¦ç»†ä¿®æ”¹æ­¥éª¤
æ­¥éª¤1ï¼šä¿®æ”¹ AccusationSystem.js
javascript// 1. ä¿®æ”¹æ•°æ®ç»“æ„
export const AccusationSystem = {
    // ... ç°æœ‰å±æ€§
    dialogueHistory: [], // ä¿®æ”¹ä¸ºæ–°æ ¼å¼
    submittedEvidence: {
        all: [], // æ‰€æœ‰æäº¤çš„è¯æ®
        byType: {
            motive: [],
            method: [],
            opportunity: [],
            conspiracy: []
        }
    },
    currentProofPrompt: '', // å½“å‰éœ€è¦è¯æ˜çš„å†…å®¹
    evidenceAnalysis: {
        proven: [],
        pending: []
    },
    
    // 2. æ–°å¢è¯æ®é™„åŠ åŠŸèƒ½
    attachedEvidence: [], // å½“å‰å¯¹è¯é™„åŠ çš„è¯æ®
    
    // 3. ä¿®æ”¹å¯¹è¯å†å²è®°å½•æ–¹æ³•
    addToHistory(detectiveMsg, npcResponse, attachedEvidence = []) {
        this.dialogueHistory.push({
            detective: detectiveMsg,
            npc: npcResponse.text,
            emotion: npcResponse.emotion,
            evidenceSubmitted: attachedEvidence
        });
        
        // æ›´æ–°å·²æäº¤è¯æ®
        if (attachedEvidence.length > 0) {
            this.submittedEvidence.all.push(...attachedEvidence);
            this.analyzeEvidence();
        }
    },
    
    // 4. æ–°å¢è¯æ®åˆ†ææ–¹æ³•
    analyzeEvidence() {
        const evidenceConfig = {
            motive: ['clue_will_draft', 'clue_deduce_inheritance_crisis', 'clue_love_letter'],
            method: ['clue_poison_bottle', 'clue_deduce_poison_source', 'clue_doctor_drug_interaction'],
            opportunity: ['clue_chen_cellar', 'clue_maid_witness', 'clue_cellar_key'],
            conspiracy: ['clue_butler_dismiss_maid', 'clue_chen_butler_relationship', 'clue_deduce_conspiracy']
        };
        
        this.evidenceAnalysis.proven = [];
        this.evidenceAnalysis.pending = [];
        
        for (const [type, required] of Object.entries(evidenceConfig)) {
            const submitted = this.submittedEvidence.all.filter(e => required.includes(e));
            if (submitted.length > 0) {
                this.evidenceAnalysis.proven.push({
                    type,
                    evidence: submitted
                });
            } else {
                this.evidenceAnalysis.pending.push({
                    type,
                    required
                });
            }
        }
    },
    
    // 5. ä¿®æ”¹å¼€å§‹å¯¹å†³æ–¹æ³•
    async startConfrontation() {
        const modal = document.getElementById('confrontation-modal');
        const dialogueContainer = document.getElementById('confrontation-dialogue');
        
        dialogueContainer.innerHTML = '';
        modal.style.display = 'flex';
        
        // è‡ªåŠ¨å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯
        const firstMessage = `${NpcData[this.currentAccused].name}ï¼Œä½ å°±æ˜¯å‡¶æ‰‹ï¼`;
        
        // ç¦ç”¨è¾“å…¥
        this.isWaitingForResponse = true;
        document.getElementById('accusation-input').disabled = true;
        document.getElementById('accusation-send').disabled = true;
        
        // æ·»åŠ ä¾¦æ¢çš„ç¬¬ä¸€æ¡å¯¹è¯
        await this.addDialogue('detective', firstMessage);
        
        // ç”ŸæˆNPCçš„ç¬¬ä¸€æ¬¡å“åº”
        const response = await this.generateNPCResponse(firstMessage);
        await this.processNPCResponse(response);
        
        // æ¢å¤è¾“å…¥
        this.isWaitingForResponse = false;
        document.getElementById('accusation-input').disabled = false;
        document.getElementById('accusation-send').disabled = false;
        document.getElementById('accusation-input').focus();
    },
    
    // 6. ä¿®æ”¹å‘é€æ¶ˆæ¯æ–¹æ³•
    async sendAccusation() {
        const input = document.getElementById('accusation-input');
        const message = input.value.trim();
        
        if (!message || this.isWaitingForResponse) return;
        
        // è·å–é™„åŠ çš„è¯æ®
        const attachedEvidence = this.attachedEvidence.slice();
        
        this.isWaitingForResponse = true;
        input.value = '';
        input.disabled = true;
        
        // æ˜¾ç¤ºå¸¦è¯æ®çš„å¯¹è¯
        let displayMessage = message;
        if (attachedEvidence.length > 0) {
            const evidenceNames = this.getEvidenceNames(attachedEvidence);
            displayMessage += ` [é™„å¸¦è¯æ®ï¼š${evidenceNames.join('ã€')}]`;
        }
        
        await this.addDialogue('detective', displayMessage);
        
        // ç”Ÿæˆå®Œæ•´çš„ç”¨æˆ·æ¶ˆæ¯ï¼ˆç”¨äºAIï¼‰
        let fullMessage = message;
        if (attachedEvidence.length > 0) {
            fullMessage = `${message}\nï¼ˆç”¨æˆ·æäº¤äº†è¯æ®ï¼š${attachedEvidence.join('ã€')}ï¼‰`;
        }
        
        // ç”Ÿæˆå“åº”
        const response = await this.generateNPCResponse(fullMessage);
        
        // è®°å½•åˆ°å†å²
        this.addToHistory(message, response, attachedEvidence);
        
        // æ¸…ç©ºé™„åŠ è¯æ®
        this.attachedEvidence = [];
        this.updateAttachedEvidenceUI();
        
        await this.processNPCResponse(response);
        
        this.isWaitingForResponse = false;
        input.disabled = false;
        input.focus();
    },
    
    // 7. ä¿®æ”¹å“åº”å¤„ç†æ–¹æ³•
    async processNPCResponse(response) {
        const npc = NpcData[this.currentAccused];
        
        // æ·»åŠ NPCå¯¹è¯
        await this.addDialogue('npc', response.text, npc.avatar, response.emotion);
        
        // å¤„ç†ç³»ç»Ÿæ§åˆ¶ä¿¡æ¯
        if (response.systemControl) {
            const control = response.systemControl;
            
            // æ›´æ–°ä¸‹ä¸€æ­¥è¯æ˜æç¤º
            if (control.next_proof_prompt) {
                this.currentProofPrompt = control.next_proof_prompt;
                this.updateProofPromptUI(control.next_proof_prompt);
            }
            
            // æ›´æ–°å‹åŠ›ç­‰çº§
            if (control.pressure_level) {
                this.pressureLevel = control.pressure_level;
                document.getElementById('pressure-level').textContent = 
                    this.getPressureLevelText(control.pressure_level);
            }
            
            // æ£€æŸ¥ç»“å±€
            if (control.ending_check) {
                if (control.ending_check.perfect_ending) {
                    setTimeout(() => this.showEnding('perfect'), 2000);
                } else if (control.ending_check.good_ending) {
                    setTimeout(() => this.showEnding('good'), 2000);
                }
            }
        }
    },
    
    // 8. æ–°å¢UIæ›´æ–°æ–¹æ³•
    updateProofPromptUI(prompt) {
        let promptElement = document.getElementById('current-proof-prompt');
        if (!promptElement) {
            // åˆ›å»ºæç¤ºå…ƒç´ 
            const header = document.querySelector('.confrontation-header');
            promptElement = document.createElement('div');
            promptElement.id = 'current-proof-prompt';
            promptElement.className = 'proof-prompt';
            header.appendChild(promptElement);
        }
        promptElement.innerHTML = `<strong>å½“å‰éœ€è¦ï¼š</strong>${prompt}`;
    },
    
    // 9. æ–°å¢è¯æ®é™„åŠ UI
    showEvidenceAttachment() {
        const modal = document.createElement('div');
        modal.id = 'evidence-attachment-modal';
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content">
                <h3>é€‰æ‹©è¦é™„åŠ çš„è¯æ®</h3>
                <div id="attachment-evidence-grid" class="evidence-grid"></div>
                <div class="attachment-controls">
                    <button onclick="AccusationSystem.confirmAttachment()">ç¡®è®¤</button>
                    <button onclick="AccusationSystem.cancelAttachment()">å–æ¶ˆ</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // æ˜¾ç¤ºå¯ç”¨è¯æ®
        const grid = document.getElementById('attachment-evidence-grid');
        const collectedClues = AIClueManager.getTriggeredClues();
        
        collectedClues.forEach(clueId => {
            const clueData = AIClueManager.getClueById(clueId);
            if (!clueData) return;
            
            const item = document.createElement('div');
            item.className = 'evidence-item';
            if (this.attachedEvidence.includes(clueId)) {
                item.classList.add('selected');
            }
            
            item.innerHTML = `
                <img src="${clueData.img}" alt="${clueData.name}">
                <div>${clueData.name}</div>
            `;
            
            item.onclick = () => this.toggleAttachedEvidence(clueId);
            grid.appendChild(item);
        });
        
        modal.style.display = 'flex';
    },
    
    toggleAttachedEvidence(clueId) {
        const index = this.attachedEvidence.indexOf(clueId);
        if (index > -1) {
            this.attachedEvidence.splice(index, 1);
        } else {
            this.attachedEvidence.push(clueId);
        }
        
        // æ›´æ–°UI
        const item = document.querySelector(`[data-clue-id="${clueId}"]`);
        if (item) {
            item.classList.toggle('selected');
        }
    }
};
æ­¥éª¤2ï¼šä¿®æ”¹ UI éƒ¨åˆ†
javascript// åœ¨ createAccusationUI æ–¹æ³•ä¸­ä¿®æ”¹å¯¹å†³ç•Œé¢
confrontModal.innerHTML = `
    <div class="modal-content confrontation-content">
        <div class="confrontation-header">
            <h2 id="confrontation-title">æŒ‡è®¤å¯¹å†³</h2>
            <div id="current-proof-prompt" class="proof-prompt"></div>
            <div id="pressure-indicator" class="pressure-indicator">
                å‹åŠ›ç­‰çº§: <span id="pressure-level">ä½</span>
            </div>
        </div>
        <div class="confrontation-stage">
            <div class="confrontation-dialogue" id="confrontation-dialogue"></div>
        </div>
        <div class="confrontation-controls">
            <div class="dialogue-input-wrapper">
                <div class="attached-evidence" id="attached-evidence-display"></div>
                <div class="dialogue-input-container">
                    <input type="text" id="accusation-input" class="dialogue-input" 
                           placeholder="è¾“å…¥ä½ çš„è´¨é—®...">
                    <button id="attach-evidence-btn" class="attach-btn" 
                            onclick="AccusationSystem.showEvidenceAttachment()">
                        ğŸ“ é™„åŠ è¯æ®
                    </button>
                    <button id="accusation-send" class="send-btn">å‘é€</button>
                </div>
            </div>
            <button id="end-confrontation" class="secondary-btn" 
                    onclick="AccusationSystem.endConfrontation()">ç»“æŸå¯¹å†³</button>
        </div>
    </div>
`;
æ­¥éª¤3ï¼šæ·»åŠ æ–°çš„æ ·å¼
css.proof-prompt {
    margin: 10px 0;
    padding: 10px;
    background: rgba(255, 107, 107, 0.1);
    border-left: 3px solid #ff6b6b;
    font-size: 16px;
}

.dialogue-input-wrapper {
    width: 100%;
}

.attached-evidence {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    min-height: 30px;
}

.attached-evidence-item {
    background: #3a3a3a;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.attached-evidence-item .remove {
    cursor: pointer;
    color: #ff6b6b;
}

.attach-btn {
    padding: 10px 15px;
    background: #555;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.evidence-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    max-height: 400px;
    overflow-y: auto;
    margin: 20px 0;
}
æ­¥éª¤4ï¼šä¿®æ”¹å“åº”è§£æ
javascript// åœ¨ parseResponse æ–¹æ³•ä¸­æ·»åŠ 
parseResponse(response) {
    const result = {
        emotion: 'å¹³é™',
        text: response,
        systemControl: null
    };
    
    // è§£ææƒ…ç»ª
    const emotionMatch = response.match(/\[([^\]]+)\]/);
    if (emotionMatch) {
        result.emotion = emotionMatch[1];
        result.text = response.replace(/\[[^\]]+\]/, '').trim();
    }
    
    // è§£æç³»ç»Ÿæ§åˆ¶
    const systemControlMatch = response.match(/<system_control>([\s\S]*?)<\/system_control>/);
    if (systemControlMatch) {
        try {
            result.systemControl = JSON.parse(systemControlMatch[1]);
            result.text = result.text.replace(/<system_control>[\s\S]*?<\/system_control>/, '').trim();
        } catch (e) {
            console.error('è§£æsystem_controlå¤±è´¥:', e);
        }
    }
    
    return result;
}
æ­¥éª¤5ï¼šä¿®æ”¹æç¤ºè¯æ„å»ºæ–¹æ³•
javascriptbuildAccusationPrompt(userMessage, character, accusationProfile) {
    // åˆ†æå·²æäº¤è¯æ®
    this.analyzeEvidence();
    
    // æ„å»ºå¯¹è¯å†å²
    const formattedHistory = this.dialogueHistory.map((entry, index) => {
        let text = `[ç¬¬${index + 1}è½®]\nä¾¦æ¢ï¼š${entry.detective}`;
        if (entry.evidenceSubmitted && entry.evidenceSubmitted.length > 0) {
            text += `\nï¼ˆæäº¤è¯æ®ï¼š${entry.evidenceSubmitted.join('ã€')}ï¼‰`;
        }
        text += `\n${character.name}ï¼š${entry.npc}`;
        return text;
    }).join('\n\n');
    
    // ä½¿ç”¨æ–°çš„Promptæ¨¡æ¿
    return `ä½ æ˜¯ä¸€ä¸ªä¸­æ–‡è§’è‰²æ‰®æ¼”æ¸¸æˆä¸­çš„NPCã€‚è¿™æ˜¯ä¸€ä¸ªä¾¦æ¢æ¨ç†æ¸¸æˆçš„æŒ‡è®¤é˜¶æ®µã€‚
    
[... å®Œæ•´çš„æ–°Promptå†…å®¹ ...]

## å½“å‰ç”¨æˆ·è¾“å…¥
${userMessage}`;
}
è¿™äº›ä¿®æ”¹å°†å®ç°ï¼š

è‡ªç”±å¯¹è¯æ¨¡å¼ï¼Œæ”¯æŒéšæ—¶é™„åŠ è¯æ®
åŠ¨æ€æ˜¾ç¤ºéœ€è¦è¯æ˜çš„å†…å®¹
å®æ—¶åˆ¤æ–­é€šå…³æ¡ä»¶
æ›´è‡ªç„¶çš„äº¤äº’ä½“éªŒ